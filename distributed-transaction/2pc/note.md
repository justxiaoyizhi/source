1. 什么是两阶段提交？分别是哪两个阶段？

  > 所谓的两个阶段是指：第一阶段：准备阶段(投票阶段)和第二阶段：提交阶段（执行阶段）。
2. 准备阶段做了哪些事情？

    > 事务协调者(事务管理器)给每个参与者(资源管理器)发送Prepare消息，每个参与者要么直接返回失败(如权限验证失败)，要么在本地执行事务，写本地的redo和undo日志，但不提交，到达一种“万事俱备，只欠东风”的状态。

    可以进一步将准备阶段分为以下三个步骤：

    > 1）协调者节点向所有参与者节点询问是否可以执行提交操作(vote)，并开始等待各参与者节点的响应。
    > 2）参与者节点执行询问发起为止的所有事务操作，并将Undo信息和Redo信息写入日志。（注意：若成功这里其实每个参与者已经执行了事务操作）
    > 3）各参与者节点响应协调者节点发起的询问。如果参与者节点的事务操作实际执行成功，则它返回一个”同意”消息；如果参与者节点的事务操作实际执行失败，则它返回一个”中止”消息。

3. 提交阶段做了哪些事情？

   > 如果协调者收到了参与者的失败消息或者超时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据协调者的指令执行提交或者回滚操作，释放所有事务处理过程中使用的锁资源。(注意:必须在最后阶段释放锁资源)

   - 当协调者节点从所有参与者节点获得的相应消息都为”同意”时:  
     >  1）协调者节点向所有参与者节点发出”正式提交(commit)”的请求。
     >  2）参与者节点正式完成操作，并释放在整个事务期间内占用的资源。
     >  3）参与者节点向协调者节点发送”完成”消息。
     >  4）协调者节点受到所有参与者节点反馈的”完成”消息后，完成事务。

   - 如果任一参与者节点在第一阶段返回的响应消息为”中止”，或者 协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时：
     >  1）协调者节点向所有参与者节点发出”回滚操作(rollback)”的请求。
     >  2）参与者节点利用之前写入的Undo信息执行回滚，并释放在整个事务期间内占用的资源。
     >  3）参与者节点向协调者节点发送”回滚完成”消息。
     >  4）协调者节点受到所有参与者节点反馈的”回滚完成”消息后，取消事务。